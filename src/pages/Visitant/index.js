
import * as faceapi from 'face-api.js';
import React, { useEffect, useState } from 'react';

export function Visitant() {

    const [modelsLoaded, setModelsLoaded] = React.useState(false);
    const [captureVideo, setCaptureVideo] = React.useState(false);

    const videoRef = React.useRef();
    const videoHeight = 480;
    const videoWidth = 640;
    const canvasRef = React.useRef();

    async function getLabeledFaceDescriptions() {
        const labels = ["Matheus", "Messi"];
        return (
            labels.map(async (label) => {
                const descriptions = [];
                const imgUrl = `./labels/Messi/1.png`
                const img = await faceapi.fetchImage(imgUrl)
                console.log(img)
                const detections = await faceapi
                    .detectSingleFace(img)
                    .withFaceLandmarks()
                    .withFaceDescriptor();
                descriptions.push(detections.descriptor);

                if (!detections) {
                    throw new Error(`no faces detected for ${label}`)
                }

                return new faceapi.LabeledFaceDescriptors(label, descriptions);
            })
        )
    }

    React.useEffect(() => {
        const loadModels = async () => {
            const MODEL_URL = '../../../models';
            console.log(MODEL_URL)
            Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL),

                faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),

                faceapi.loadSsdMobilenetv1Model(MODEL_URL),
                faceapi.loadFaceLandmarkModel(MODEL_URL),
                faceapi.loadFaceRecognitionModel(MODEL_URL),
            ]).then(setModelsLoaded(true));
        }
        loadModels();
    }, []);

    const startVideo = () => {
        setCaptureVideo(true);
        navigator.mediaDevices
            .getUserMedia({ video: { width: 300 } })
            .then(stream => {
                let video = videoRef.current;
                video.srcObject = stream;
                video.play();
            })
            .catch(err => {
                console.error("error:", err);
            });
    }

    const closeWebcam = () => {
        videoRef.current.pause();
        videoRef.current.srcObject.getTracks()[0].stop();
        setCaptureVideo(false);
    }

    const test =
        [
            {
                label: "Matheus",
                descriptors: [
                    [
                        -0.04866917058825493,
                        0.07332861423492432,
                        0.08490587770938873,
                        0.014317033812403679,
                        -0.016475344076752663,
                        -0.08306416869163513,
                        -0.027089769020676613,
                        -0.08770090341567993,
                        0.0893622487783432,
                        -0.14261147379875183,
                        0.27673500776290894,
                        -0.046902548521757126,
                        -0.2647557258605957,
                        -0.08074207603931427,
                        0.02783581241965294,
                        0.11036763340234756,
                        -0.13112877309322357,
                        -0.05556052178144455,
                        -0.12424704432487488,
                        -0.08180392533540726,
                        0.13844028115272522,
                        0.05766074359416962,
                        0.06559603661298752,
                        0.035671308636665344,
                        -0.19125208258628845,
                        -0.33598989248275757,
                        -0.10920926928520203,
                        -0.14495348930358887,
                        -0.06289999932050705,
                        -0.08717303723096848,
                        0.009662316180765629,
                        0.01961389370262623,
                        -0.07480362057685852,
                        -0.03077784739434719,
                        0.02407405897974968,
                        0.0034809913486242294,
                        -0.09202282875776291,
                        -0.05231010168790817,
                        0.1625356376171112,
                        0.0071192518807947636,
                        -0.12338737398386002,
                        0.032812558114528656,
                        0.06362345814704895,
                        0.22140859067440033,
                        0.11786068230867386,
                        0.09017988294363022,
                        0.08129866421222687,
                        -0.06458139419555664,
                        0.15125373005867004,
                        -0.22554923593997955,
                        0.0744946077466011,
                        0.09201420098543167,
                        0.19079093635082245,
                        0.08157382160425186,
                        0.24212858080863953,
                        -0.1507362723350525,
                        0.049724530428647995,
                        0.11614367365837097,
                        -0.17949587106704712,
                        0.13676461577415466,
                        0.022583523765206337,
                        -0.025377605110406876,
                        0.01639643870294094,
                        -0.022214366123080254,
                        0.1601072996854782,
                        0.05584888532757759,
                        -0.11930304020643234,
                        -0.061778031289577484,
                        0.14287495613098145,
                        -0.11842412501573563,
                        -0.0647335946559906,
                        0.15286479890346527,
                        -0.12014658004045486,
                        -0.22151197493076324,
                        -0.20635227859020233,
                        -0.03366413712501526,
                        0.41812843084335327,
                        0.1386311650276184,
                        -0.15847833454608917,
                        -0.030966533347964287,
                        -0.07980464398860931,
                        -0.0432538241147995,
                        0.04599671810865402,
                        -0.0024043123703449965,
                        -0.07150983810424805,
                        -0.059920404106378555,
                        -0.1290411651134491,
                        0.016279317438602448,
                        0.17518694698810577,
                        -0.024988653138279915,
                        -0.052914440631866455,
                        0.28082701563835144,
                        0.0017522248672321439,
                        0.025176335126161575,
                        0.019932813942432404,
                        -0.05302514135837555,
                        -0.1663704663515091,
                        -0.005098952911794186,
                        -0.019596563652157784,
                        -0.04420844465494156,
                        0.009064961224794388,
                        -0.16157253086566925,
                        -0.048995766788721085,
                        -0.004563192371279001,
                        -0.17833341658115387,
                        0.15355919301509857,
                        -0.03636237978935242,
                        0.044786352664232254,
                        -0.02131735347211361,
                        0.0885782390832901,
                        -0.19706319272518158,
                        0.04291704669594765,
                        0.11473365128040314,
                        -0.30450257658958435,
                        0.14198029041290283,
                        0.15220433473587036,
                        0.032728422433137894,
                        0.11048076301813126,
                        0.017821718007326126,
                        0.03588125482201576,
                        -0.03332000598311424,
                        -0.05954139307141304,
                        -0.19363027811050415,
                        -0.11083213984966278,
                        0.0498325377702713,
                        -0.02071068249642849,
                        0.03852635994553566,
                        0.0037881259340792894
                    ],
                    [
                        -0.061954326927661896,
                        0.08228863775730133,
                        0.05137522146105766,
                        -0.014371456578373909,
                        0.01693236455321312,
                        -0.09276104718446732,
                        0.008811725303530693,
                        -0.0832270160317421,
                        0.10311253368854523,
                        -0.08738385140895844,
                        0.3081454932689667,
                        -0.07699726521968842,
                        -0.23617219924926758,
                        -0.1337084174156189,
                        0.055006030946969986,
                        0.12239395827054977,
                        -0.1914845108985901,
                        -0.08347433060407639,
                        -0.10812829434871674,
                        -0.1155552938580513,
                        0.08756402879953384,
                        0.030265891924500465,
                        0.05278652533888817,
                        0.05952849239110947,
                        -0.1780117154121399,
                        -0.37473684549331665,
                        -0.08054988831281662,
                        -0.21457573771476746,
                        -0.029290178790688515,
                        -0.11949783563613892,
                        0.006585053633898497,
                        0.036206699907779694,
                        -0.13311730325222015,
                        -0.05403508245944977,
                        0.019890425726771355,
                        -0.024918410927057266,
                        -0.01677124574780464,
                        -0.08278655260801315,
                        0.1541028469800949,
                        0.025543466210365295,
                        -0.11293578147888184,
                        0.020075757056474686,
                        0.0725560113787651,
                        0.24492329359054565,
                        0.10371416062116623,
                        0.03935777768492699,
                        0.05515030771493912,
                        -0.07593691349029541,
                        0.1491854339838028,
                        -0.20299068093299866,
                        0.08467303961515427,
                        0.07768480479717255,
                        0.16190780699253082,
                        0.055739205330610275,
                        0.20240068435668945,
                        -0.1210845485329628,
                        0.04327124357223511,
                        0.08636428415775299,
                        -0.2165171355009079,
                        0.13885554671287537,
                        0.03478766605257988,
                        -0.004156526178121567,
                        -0.029374970123171806,
                        -0.05550695210695267,
                        0.17452813684940338,
                        0.1089983880519867,
                        -0.09757670015096664,
                        -0.07621180266141891,
                        0.09571656584739685,
                        -0.11332494020462036,
                        -0.07805763930082321,
                        0.11108618974685669,
                        -0.11225442588329315,
                        -0.20713575184345245,
                        -0.23211131989955902,
                        -0.0009149169200100005,
                        0.38910210132598877,
                        0.1421782225370407,
                        -0.20353224873542786,
                        -0.011760083958506584,
                        -0.0943358913064003,
                        -0.05725298076868057,
                        0.10099365562200546,
                        0.05192819610238075,
                        -0.07062307000160217,
                        -0.020273009315133095,
                        -0.10041482746601105,
                        0.03319525718688965,
                        0.1643846482038498,
                        0.00688984664157033,
                        -0.06351184844970703,
                        0.2762854993343353,
                        -0.06952768564224243,
                        0.027950678020715714,
                        0.016503868624567986,
                        -0.0604875423014164,
                        -0.1618761569261551,
                        0.0003087174263782799,
                        -0.026739081367850304,
                        -0.06926842778921127,
                        0.03516554459929466,
                        -0.11576858162879944,
                        -0.06054873391985893,
                        0.020227855071425438,
                        -0.1981441229581833,
                        0.08356007933616638,
                        -0.015350976958870888,
                        0.019427726045250893,
                        0.015198830515146255,
                        0.07177187502384186,
                        -0.10916441679000854,
                        0.0034488001838326454,
                        0.08546201884746552,
                        -0.2867890000343323,
                        0.16079425811767578,
                        0.1545371413230896,
                        0.03135574981570244,
                        0.11723823845386505,
                        -0.0007695785607211292,
                        0.01678609475493431,
                        -0.0317327044904232,
                        -0.06517910957336426,
                        -0.1952669769525528,
                        -0.05063638836145401,
                        0.07624950259923935,
                        0.0027752376627177,
                        0.026832610368728638,
                        -0.035346075892448425
                    ]
                ]
            },
            {
                label: "Messi",
                descriptors: [
                    [
                        -0.11178659647703171,
                        0.13962990045547485,
                        0.029535481706261635,
                        -0.07755859941244125,
                        -0.14883729815483093,
                        0.11869759112596512,
                        -0.023081565275788307,
                        -0.07722402364015579,
                        0.19685199856758118,
                        -0.019639914855360985,
                        0.2390121966600418,
                        -0.021113354712724686,
                        -0.2660261392593384,
                        0.009030469693243504,
                        -0.07086028158664703,
                        0.13010956346988678,
                        -0.17079780995845795,
                        -0.06843142211437225,
                        -0.12823286652565002,
                        -0.17056435346603394,
                        -0.03907671198248863,
                        0.10152804851531982,
                        0.011832725256681442,
                        0.033973995596170425,
                        -0.12051472812891006,
                        -0.24141588807106018,
                        -0.007646217476576567,
                        -0.2298358827829361,
                        0.044404059648513794,
                        -0.12977096438407898,
                        0.03317045792937279,
                        0.014748197048902512,
                        -0.08504122495651245,
                        -0.023378411307930946,
                        0.01232280395925045,
                        -0.023777469992637634,
                        -0.0989719107747078,
                        -0.11185454577207565,
                        0.2839442789554596,
                        -0.0714837983250618,
                        -0.10594866424798965,
                        0.054349929094314575,
                        0.08179636299610138,
                        0.28249818086624146,
                        0.14551828801631927,
                        -0.019334176555275917,
                        0.004276917781680822,
                        -0.1143166720867157,
                        0.20505885779857635,
                        -0.2518356144428253,
                        0.11992760747671127,
                        0.15557149052619934,
                        0.141780287027359,
                        0.10314687341451645,
                        0.06876572966575623,
                        -0.19226329028606415,
                        -0.005587245803326368,
                        0.1455165296792984,
                        -0.220268115401268,
                        0.06479767709970474,
                        0.07103769481182098,
                        -0.022598793730139732,
                        -0.08312705904245377,
                        -0.14971791207790375,
                        0.24188025295734406,
                        0.19649629294872284,
                        -0.12855149805545807,
                        -0.16701850295066833,
                        0.07667864114046097,
                        -0.10954101383686066,
                        -0.0920853316783905,
                        0.08422540873289108,
                        -0.1678617298603058,
                        -0.15092873573303223,
                        -0.2427624762058258,
                        0.1030900776386261,
                        0.37814271450042725,
                        0.1572132408618927,
                        -0.16338282823562622,
                        -0.004040357656776905,
                        -0.08407759666442871,
                        -0.02217085100710392,
                        -0.01790718361735344,
                        0.03257538378238678,
                        -0.16178347170352936,
                        -0.09310957044363022,
                        0.009807910770177841,
                        -0.000842277891933918,
                        0.15802812576293945,
                        -0.0494624488055706,
                        -0.07642000913619995,
                        0.19473432004451752,
                        0.027151094749569893,
                        -0.04506964236497879,
                        -0.0047662160359323025,
                        0.02412835694849491,
                        -0.1305822730064392,
                        -0.03832625597715378,
                        -0.0660397931933403,
                        -0.006847335025668144,
                        0.037186600267887115,
                        -0.1039452850818634,
                        0.05949990823864937,
                        0.061121221631765366,
                        -0.26402145624160767,
                        0.21745169162750244,
                        -0.02335919439792633,
                        -0.01742345280945301,
                        0.022450173273682594,
                        -0.01365587953478098,
                        -0.06285735964775085,
                        0.061816178262233734,
                        0.2824961841106415,
                        -0.2674901485443115,
                        0.25750619173049927,
                        0.06540916115045547,
                        0.09398985654115677,
                        0.20496413111686707,
                        0.07856832444667816,
                        0.0902138277888298,
                        -0.06946779042482376,
                        0.0566771924495697,
                        -0.15053239464759827,
                        -0.0824349895119667,
                        0.1195778176188469,
                        -0.015910226851701736,
                        0.08445745706558228,
                        0.07736601680517197
                    ],
                    [
                        -0.10217218101024628,
                        0.09302534908056259,
                        0.030157972127199173,
                        -0.062041107565164566,
                        -0.1332811564207077,
                        0.09939099848270416,
                        -0.08025959879159927,
                        -0.024240296334028244,
                        0.13332803547382355,
                        -0.053437866270542145,
                        0.25721561908721924,
                        -0.016819864511489868,
                        -0.21884891390800476,
                        -0.02204967848956585,
                        -0.06488487869501114,
                        0.09975315630435944,
                        -0.14098292589187622,
                        -0.01616385392844677,
                        -0.16066870093345642,
                        -0.1346060186624527,
                        -0.07996426522731781,
                        0.0948549285531044,
                        0.014307396486401558,
                        0.03650011494755745,
                        -0.14068745076656342,
                        -0.29720795154571533,
                        -0.030191510915756226,
                        -0.14572502672672272,
                        0.13229228556156158,
                        -0.16497808694839478,
                        -0.024343907833099365,
                        0.02695452608168125,
                        -0.11260275542736053,
                        -0.014631468802690506,
                        0.06905607134103775,
                        0.040102891623973846,
                        -0.024091294035315514,
                        -0.12385594844818115,
                        0.20168274641036987,
                        -0.0782097578048706,
                        -0.07181937992572784,
                        0.06082794442772865,
                        0.11789338290691376,
                        0.22903861105442047,
                        0.10395120084285736,
                        0.02465801127254963,
                        0.009733046405017376,
                        -0.0785597711801529,
                        0.195573627948761,
                        -0.19172659516334534,
                        0.11122041940689087,
                        0.10772743821144104,
                        0.13339444994926453,
                        0.08588992804288864,
                        0.08402466028928757,
                        -0.17064142227172852,
                        0.00801097135990858,
                        0.16405406594276428,
                        -0.209858238697052,
                        0.08475644886493683,
                        0.016452468931674957,
                        0.017857542261481285,
                        -0.13597263395786285,
                        -0.09725136309862137,
                        0.20130987465381622,
                        0.20694774389266968,
                        -0.1344195306301117,
                        -0.22899995744228363,
                        0.1078738421201706,
                        -0.16904020309448242,
                        -0.00814126618206501,
                        0.09873849898576736,
                        -0.092340849339962,
                        -0.11607854813337326,
                        -0.15825797617435455,
                        0.10546411573886871,
                        0.3029082119464874,
                        0.16907232999801636,
                        -0.194027841091156,
                        0.004460472147911787,
                        -0.009138171561062336,
                        -0.08039997518062592,
                        -0.030832020565867424,
                        0.04645216464996338,
                        -0.17121674120426178,
                        -0.06904346495866776,
                        0.019394047558307648,
                        0.010941768996417522,
                        0.19594737887382507,
                        0.04288722947239876,
                        -0.00978771410882473,
                        0.20818059146404266,
                        0.0377877838909626,
                        -0.051117464900016785,
                        0.021439827978610992,
                        -0.009417014196515083,
                        -0.17770537734031677,
                        -0.07278912514448166,
                        -0.040515925735235214,
                        -0.008890156634151936,
                        0.09289152920246124,
                        -0.11721017956733704,
                        0.010996954515576363,
                        0.06412699818611145,
                        -0.21749208867549896,
                        0.21898698806762695,
                        -0.06435545533895493,
                        -0.033229291439056396,
                        0.10233595222234726,
                        0.021143244579434395,
                        -0.059475503861904144,
                        0.007330987602472305,
                        0.23674049973487854,
                        -0.2734675705432892,
                        0.24780181050300598,
                        0.06854338198900223,
                        0.13464660942554474,
                        0.15998002886772156,
                        0.09005573391914368,
                        0.09928641468286514,
                        0.036856770515441895,
                        0.08306383341550827,
                        -0.10513769090175629,
                        -0.1424695998430252,
                        0.06525415182113647,
                        -0.16605737805366516,
                        0.040347788482904434,
                        -0.010871877893805504
                    ]
                ]
            }
        ]



    const handleVideoOnPlay = async () => {
        //const labeledFaceDescriptors = await getLabeledFaceDescriptions();
        //console.log('labeledFaceDescriptors ->', labeledFaceDescriptors)

        //const faceMatcher = new faceapi.FaceMatcher(test);

        //   console.log(faceMatcher)



        setInterval(async () => {
            if (canvasRef && canvasRef.current) {


                canvasRef.current.innerHTML = faceapi.createCanvasFromMedia(videoRef.current);


                const displaySize = {
                    width: videoWidth,
                    height: videoHeight
                }


                faceapi.matchDimensions(canvasRef.current, displaySize);

                const detections = await faceapi.detectAllFaces(videoRef.current, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceExpressions();

                const resizedDetections = faceapi.resizeResults(detections, displaySize);

                canvasRef && canvasRef.current && canvasRef.current.getContext('2d').clearRect(0, 0, videoWidth, videoHeight);
                canvasRef && canvasRef.current && faceapi.draw.drawDetections(canvasRef.current, resizedDetections)
                const box = resizedDetections[0].detection.box;
                canvasRef && canvasRef.current && faceapi.draw.DrawBox(box, {
                    label: 'Recusado',
                })

                const results = resizedDetections.map((d) => {
                    // return test.findBestMatch(d.descriptor);//obtem os dados da webcam e compara esses dados com as fotos
                });

                //console.log(results)

                //canvasRef && canvasRef.current && faceapi.draw.drawFaceLandmarks(canvasRef.current, resizedDetections);
                //canvasRef && canvasRef.current && faceapi.draw.drawFaceExpressions(canvasRef.current, resizedDetections);


            }
        }, 100)
    }

    return (
        <div>
            <div style={{ textAlign: 'center', padding: '10px' }}>
                {
                    captureVideo && modelsLoaded ?
                        <button onClick={closeWebcam} style={{ cursor: 'pointer', backgroundColor: 'green', color: 'white', padding: '15px', fontSize: '25px', border: 'none', borderRadius: '10px' }}>
                            Close Webcam
                        </button>
                        :
                        <button onClick={startVideo} style={{ cursor: 'pointer', backgroundColor: 'green', color: 'white', padding: '15px', fontSize: '25px', border: 'none', borderRadius: '10px' }}>
                            Open Webcam
                        </button>
                }
            </div>
            {
                captureVideo ?
                    modelsLoaded ?
                        <div>
                            <div style={{ display: 'flex', justifyContent: 'center', padding: '10px' }}>
                                <video ref={videoRef} height={videoHeight} width={videoWidth} onPlay={handleVideoOnPlay} style={{ borderRadius: '10px' }} />
                                <canvas ref={canvasRef} style={{ position: 'absolute' }} />
                            </div>
                        </div>
                        :
                        <div>loading...</div>
                    :
                    <>
                    </>
            }
        </div>
    );
}
